generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgres"
  url      = env("DATABASE_URL")
}

model User {
  id                  String              @id @default(uuid())
  email               String              @unique
  password            String
  role                Role
  name                String
  profilePicture      String? // URL to profile picture
  passwordResetToken  String? // Hashed token for password reset
  passwordResetExpiry DateTime? // Expiration time for reset token
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  verified            Boolean             @default(false)
  verifications       VerificationLog[]
  favorites           UserFavorites[]
  notifications       UserNotifications[]
  reports             Report[]
}

model Manufacturer {
  id                           String                      @id @default(uuid())
  userId                       String                      @unique
  name                         String
  email                        String                      @default("")
  phone                        String?
  country                      String                      @default("")
  verified                     Boolean                     @default(false)
  accountStatus                String                      @default("pending_verification") // pending_verification, verified, rejected
  trustScore                   Float                       @default(0)
  riskLevel                    String                      @default("MEDIUM") // LOW, MEDIUM, HIGH
  plan                         String                      @default("BASIC") // BASIC (50/day), PREMIUM (1000/day)
  companyName                  String?
  website                      String?
  nafdacLicensePath            String?
  businessCertificatePath      String?
  photoIdPath                  String?
  createdAt                    DateTime                    @default(now())
  updatedAt                    DateTime                    @updatedAt
  lastActivityAt               DateTime?
  riskScore                    Int?                        @default(50)
  lastRiskAssessment           DateTime?
  lastTrustAssessment          DateTime?
  websiteVerified              Boolean?                    @default(false)
  businessCertificateVerified  Boolean?                    @default(false)
  nafdacLicenseVerified        Boolean?                    @default(false)
  drugs                        Drug[]
  batches                      Batch[]
  codes                        Code[]
  verificationLogs             VerificationLog[]
  documents                    Document[]
  payments                     Payment[]
  billingHistory               BillingHistory[]
  disputes                     Dispute[]
  teamMembers                  TeamMember[]
  teamInvites                  TeamInvite[]
  websiteChecks                WebsiteLegitimacyCheck[]
  documentChecks               DocumentForgerCheck[]
  trustHistory                 TrustScoreHistory[]
  apiKeys                      ApiKey[]
  batchRecalls                 BatchRecall[]
  analyticsReports             AnalyticsReport[]
  reportSchedules              ReportSchedule[]
  analyticsAudits              AnalyticsAudit[]
  manufacturerReview           ManufacturerReview?

  @@index([userId])
  @@index([email])
  @@index([accountStatus])
}

model Drug {
  id             String       @id @default(uuid())
  name           String
  category       String
  manufacturerId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id])

  @@index([manufacturerId])
}

model Batch {
  id               String            @id @default(uuid())
  batchNumber      String
  productId        String
  productionDate   DateTime
  expirationDate   DateTime
  manufacturerId   String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  manufacturer     Manufacturer      @relation(fields: [manufacturerId], references: [id])
  product          Product           @relation(fields: [productId], references: [id])
  codes            Code[]
  verificationLogs VerificationLog[]

  @@index([batchNumber])
  @@index([expirationDate])
  @@index([manufacturerId])
}

model Code {
  id               String            @id @default(uuid())
  codeValue        String            @unique
  qrImagePath      String?
  batchId          String
  manufacturerId   String
  isUsed           Boolean           @default(false)
  usedAt           DateTime?
  firstVerifiedAt  DateTime?
  usedCount        Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  batch            Batch             @relation(fields: [batchId], references: [id])
  manufacturer     Manufacturer      @relation(fields: [manufacturerId], references: [id])
  verificationLogs VerificationLog[]
  Product          Product?          @relation(fields: [productId], references: [id])
  productId        String?

  @@index([codeValue])
  @@index([isUsed])
  @@index([manufacturerId])
}

model VerificationLog {
  id                String            @id @default(uuid())
  codeId            String?
  batchId           String?
  manufacturerId    String?
  codeValue         String
  userId            String? // nullable for guest verification
  timestamp         DateTime          @default(now())
  createdAt         DateTime          @default(now())
  location          String? // optional geo
  verificationState VerificationState
  latitude          Float?
  longitude         Float?
  riskScore         Float?
  code              Code?             @relation(fields: [codeId], references: [id])
  batch             Batch?            @relation(fields: [batchId], references: [id])
  manufacturer      Manufacturer?     @relation(fields: [manufacturerId], references: [id])
  user              User?             @relation(fields: [userId], references: [id])

  @@index([codeValue])
  @@index([verificationState])
  @@index([createdAt])
  @@index([userId])
}

model Alert {
  id        String   @id @default(uuid())
  codeId    String
  type      String
  riskScore Float
  location  String
  timestamp DateTime @default(now())
}

model Incident {
  id        String            @id @default(uuid())
  codeValue String
  riskScore Float
  state     VerificationState
  status    String // OPEN, UNDER_REVIEW, CLOSED
  latitude  Float?
  longitude Float?
  createdAt DateTime          @default(now())

  @@index([status])
}

model Product {
  id             String   @id @default(uuid())
  manufacturerId String
  name           String
  description    String?
  createdAt      DateTime @default(now())
  batches        Batch[]
  category       String
  skuPrefix      String?
  codes          Code[]
}

model UserFavorites {
  id          String   @id @default(uuid())
  userId      String
  codeValue   String
  productName String?
  productId   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, codeValue])
  @@index([userId])
}

model UserNotifications {
  id        String   @id @default(uuid())
  userId    String
  type      String // VERIFICATION, ALERT, GENERAL
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model Report {
  id               String    @id @default(uuid())
  codeValue        String
  productName      String?
  reportType       String // counterfeit, fake_packaging, invalid_code, quality_issue, other
  description      String    @db.Text
  location         String?
  purchaseDate     DateTime?
  purchaseLocation String?
  contact          String?
  userId           String?
  latitude         Float? // Reporter's location latitude
  longitude        Float? // Reporter's location longitude
  status           String    @default("OPEN") // OPEN, UNDER_REVIEW, RESOLVED, DISMISSED
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([createdAt])
  @@index([codeValue])
}

enum Role {
  CONSUMER
  MANUFACTURER
  ADMIN
  NAFDAC
}

enum VerificationState {
  GENUINE
  CODE_ALREADY_USED
  INVALID
  UNREGISTERED_PRODUCT
  SUSPICIOUS_PATTERN
}

model Document {
  id              String       @id @default(uuid())
  manufacturerId  String
  type            String // cac, trademark, regulatory, factory, website, contract, authorization
  filename        String
  filepath        String
  status          String       @default("pending_review") // pending_review, approved, rejected
  uploadedAt      DateTime     @default(now())
  approvedAt      DateTime?
  rejectionReason String?
  manufacturer    Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@unique([manufacturerId, type])
  @@index([manufacturerId])
  @@index([status])
}

model Payment {
  id               String       @id @default(uuid())
  manufacturerId   String
  reference        String       @unique
  amount           Int // Amount in NGN (kobo)
  planId           String
  status           String       @default("pending") // pending, success, failed
  accessCode       String?
  authorizationUrl String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  dispute          Dispute?

  @@index([manufacturerId])
  @@index([reference])
  @@index([status])
}

model BillingHistory {
  id              String       @id @default(uuid())
  manufacturerId  String
  reference       String
  amount          Int // Amount in NGN
  planId          String
  status          String       @default("completed") // completed, failed, refunded
  transactionDate DateTime     @default(now())
  createdAt       DateTime     @default(now())
  manufacturer    Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@index([manufacturerId])
  @@index([reference])
}

model Dispute {
  id               String       @id @default(uuid())
  paymentId        String       @unique
  manufacturerId   String
  reference        String
  amount           Int // Amount in NGN
  reason           String // Unauthorized charge, duplicate transaction, services not rendered, product issue, other
  description      String       @db.Text
  status           String       @default("OPEN") // OPEN, UNDER_INVESTIGATION, RESOLVED, REFUNDED, REJECTED
  resolutionNotes  String?      @db.Text
  refundAmount     Int? // Refund amount in kobo (can be partial)
  refundedAt       DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  resolvedBy       String? // Admin userId who resolved the dispute
  resolvedAt       DateTime?
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  payment          Payment      @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([manufacturerId])
  @@index([status])
  @@index([createdAt])
}

model TeamMember {
  id               String       @id @default(uuid())
  manufacturerId   String
  email            String
  name             String
  role             String       @default("viewer") // admin, editor, viewer
  status           String       @default("active") // active, inactive, removed
  joinedAt         DateTime     @default(now())
  lastActiveAt     DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@unique([manufacturerId, email])
  @@index([manufacturerId])
  @@index([role])
}

model TeamInvite {
  id               String       @id @default(uuid())
  manufacturerId   String
  email            String
  role             String       @default("viewer") // admin, editor, viewer
  token            String       @unique
  status           String       @default("pending") // pending, accepted, expired
  expiresAt        DateTime
  acceptedAt       DateTime?
  createdAt        DateTime     @default(now())
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@unique([manufacturerId, email])
  @@index([manufacturerId])
  @@index([token])
}

model WebsiteLegitimacyCheck {
  id                   String       @id @default(cuid())
  manufacturerId       String
  manufacturer         Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  domain               String
  riskScore            Int
  verdict              String       // LEGITIMATE, MODERATE, SUSPICIOUS
  registrationAgeInDays Int?
  hasSsl               Boolean?
  isFlagged            Boolean?
  companyNameFound     Boolean?
  checkDetails         String?      // JSON
  checkedAt            DateTime     @default(now())

  @@index([manufacturerId])
  @@index([checkedAt])
}

model DocumentForgerCheck {
  id                   String       @id @default(cuid())
  manufacturerId       String
  manufacturer         Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  documentType         String       // NAFDAC_LICENSE, BUSINESS_CERT, PHOTO_ID
  filePath             String
  riskScore            Int
  verdict              String       // LEGITIMATE, MODERATE_RISK, SUSPICIOUS, LIKELY_FORGED
  elaResult            String?      // JSON
  metadataResult       String?      // JSON
  qualityScore         Int?
  hasSecurityFeatures  Boolean?
  checkDetails         String?      // JSON
  checkedAt            DateTime     @default(now())

  @@index([manufacturerId])
  @@index([documentType])
  @@index([checkedAt])
}

model TrustScoreHistory {
  id             String       @id @default(cuid())
  manufacturerId String
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  score          Int
  recordedAt     DateTime     @default(now())

  @@index([manufacturerId])
  @@index([recordedAt])
}

model ApiKey {
  id               String       @id @default(cuid())
  manufacturerId   String
  keyHash          String       @unique
  name             String
  scope            String       // read,generate,revoke (comma-separated)
  rateLimit        Int          @default(1000) // requests per day
  usageCount       Int          @default(0)
  isActive         Boolean      @default(true)
  lastUsedAt       DateTime?
  expiresAt        DateTime?
  createdAt        DateTime     @default(now())
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@index([manufacturerId])
  @@index([isActive])
  @@index([createdAt])
}

model BatchRecall {
  id               String       @id @default(cuid())
  batchId          String
  manufacturerId   String
  reason           String       // quality_issue, safety_concern, counterfeit_detected, other
  description      String       @db.Text
  recalledUnits    Int?
  status           String       @default("active") // active, closed, appealed
  initiatedAt      DateTime     @default(now())
  closedAt         DateTime?
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@index([manufacturerId])
  @@index([status])
  @@index([initiatedAt])
}

model AnalyticsReport {
  id               String       @id @default(cuid())
  manufacturerId   String
  title            String
  period           String       // week, month, quarter, custom
  startDate        DateTime
  endDate          DateTime
  metrics          Json         // JSON with all metrics
  authenticity     Int?         // % genuine codes
  geoDistribution  Json?        // Geographic data
  expiredBatches   Int?
  suspiciousActivity Int?
  exportFormat     String       @default("pdf") // pdf, csv, json
  exportPath       String?
  generatedAt      DateTime     @default(now())
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@index([manufacturerId])
  @@index([generatedAt])
}

model ReportSchedule {
  id               String       @id @default(cuid())
  manufacturerId   String
  name             String
  frequency        String       // daily, weekly, monthly
  format           String       // pdf, csv, json
  recipients       Json         // array of emails
  metrics          Json         // selected metrics
  dayOfWeek        Int?         // 0-6 for weekly
  dayOfMonth       Int?         // 1-31 for monthly
  hour             Int          @default(9) // hour to send
  isActive         Boolean      @default(true)
  lastSentAt       DateTime?
  createdAt        DateTime     @default(now())
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@index([manufacturerId])
  @@index([isActive])
}

// Add to Manufacturer model relations
model AnalyticsAudit {
  id               String       @id @default(cuid())
  manufacturerId   String
  actionType       String       // api_call, report_access, export, recall_initiated
  details          Json
  ipAddress        String?
  timestamp        DateTime     @default(now())
  manufacturer     Manufacturer @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)

  @@index([manufacturerId])
  @@index([timestamp])
}

// ========== ADMIN SYSTEM MODELS ==========

model AdminUser {
  id                    String             @id @default(uuid())
  email                 String             @unique
  passwordHash          String
  firstName             String
  lastName              String
  role                  String             // SUPER_ADMIN, MODERATOR, ANALYST, SUPPORT
  twoFactorSecret       String?            // TOTP secret (encrypted)
  twoFactorEnabled      Boolean            @default(true)
  isActive              Boolean            @default(true)
  lastLogin             DateTime?
  lastLoginIp           String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  adminLogs             AdminAuditLog[]
  manufacturerReviews   ManufacturerReview[]
  userReports           UserReport[]
  caseFiles             CaseFile[]
  caseNotes             CaseNote[]

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([lastLogin])
}

model AdminAuditLog {
  id                 String       @id @default(uuid())
  adminId            String
  action             String       // review_manufacturer, approve, reject, escalate_to_nafdac, etc
  resourceType       String       // Manufacturer, UserReport, CaseFile, etc
  resourceId         String
  beforeState        Json?        // State before change
  afterState         Json?        // State after change
  reason             String?
  ipAddress          String?
  userAgent          String?
  timestamp          DateTime     @default(now())
  admin              AdminUser    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([timestamp])
  @@index([resourceType])
  @@index([action])
}

model ManufacturerReview {
  id                       String        @id @default(uuid())
  manufacturerId           String        @unique
  adminId                  String?
  status                   String        @default("pending") // pending, approved, rejected, needs_docs
  riskAssessment           String?       // AI risk summary
  trustScore               Float?
  documentVerification     Json?         // { docName: verified }
  rejectionReason          String?
  requestedDocuments       String[]      // array of requested doc types
  reviewedAt               DateTime?
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  manufacturer             Manufacturer  @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  admin                    AdminUser?    @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([manufacturerId])
  @@index([status])
  @@index([createdAt])
}

model UserReport {
  id                 String         @id @default(uuid())
  reporterId         String?        // User ID (may be null for anonymous)
  reporterEmail      String?        // Optional email for follow-up
  productName        String?
  productCode        String?
  scanType           String?        // MANUAL, QR
  location           String         // Geographic location
  latitude           Float?
  longitude          Float?
  reason             String         // Looks fake, Side effects, Wrong packaging, Expired, Other
  description        String?
  imagePath          String?        // Optional photo of packaging
  verificationId     String?        // Link to VerificationLog if applicable
  productId          String?        // Link to Product if identified
  manufacturerId     String?        // Link to Manufacturer if identified
  status             String         @default("NEW") // NEW, UNDER_REVIEW, ESCALATED, RESOLVED, DISMISSED
  riskLevel          String?        // PENDING, LOW, MEDIUM, HIGH, CRITICAL
  adminNotes         String?
  reviewedByAdminId  String?
  relatedCaseId      String?
  frequency          Int            @default(1) // How many times reported (auto-increment)
  reportedAt         DateTime       @default(now())
  reviewedAt         DateTime?
  admin              AdminUser?     @relation(fields: [reviewedByAdminId], references: [id], onDelete: SetNull)
  caseFile           CaseFile?      @relation("CaseToReports", fields: [relatedCaseId], references: [id], onDelete: SetNull)

  @@index([reporterId])
  @@index([status])
  @@index([riskLevel])
  @@index([reportedAt])
  @@index([verificationId])
  @@index([productId])
}

model CaseFile {
  id                 String         @id @default(uuid())
  caseNumber         String         @unique
  productId          String?
  batchId            String?
  manufacturerId     String?
  primaryReportId    String?        // First user report that triggered case
  status             String         @default("open") // open, under_review, escalated, closed
  severity           String         @default("medium") // low, medium, high, critical
  title              String
  description        String?
  locations          String[]       // Affected regions
  userReports        UserReport[]   @relation("CaseToReports")
  aiAnalysis         Json?          // AI risk scoring results
  verificationEvidence Json?        // Linked verifications
  nafdacReported     Boolean        @default(false)
  nafdacReportDate   DateTime?
  nafdacStatus       String?        // pending, acknowledged, investigating, resolved
  nafdacReference    String?        // Case number from NAFDAC
  adminNotes         String?
  assignedAdminId    String?
  closedAt           DateTime?
  closedReason       String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  notes              CaseNote[]
  assignedAdmin      AdminUser?     @relation(fields: [assignedAdminId], references: [id], onDelete: SetNull)

  @@index([caseNumber])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@index([nafdacReported])
}

model CaseNote {
  id             String       @id @default(uuid())
  caseId         String
  adminId        String
  content        String
  isInternal     Boolean      @default(true) // Internal notes only, not shared
  createdAt      DateTime     @default(now())
  case           CaseFile     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  admin          AdminUser    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([adminId])
}
